name: Deploy to UEG Server

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  # ==========================================
  # VERIFICAÃ‡ÃƒO PRÃ‰VIA
  # ==========================================
  pre-check:
    runs-on: ubuntu-latest
    name: ðŸ” Pre-deployment Checks
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Verify server connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ðŸ” Verificando servidor..."
            echo "Sistema: $(uname -a)"
            echo "EspaÃ§o em disco:"
            df -h | grep -E "Filesystem|/$"
            echo "Containers Docker:"
            cd ~/docker-ueg-projects && docker-compose ps | grep ana || echo "Containers ANA nÃ£o encontrados"
            echo "âœ… Servidor acessÃ­vel!"

  # ==========================================
  # BUILD
  # ==========================================
  build:
    runs-on: ubuntu-latest
    needs: pre-check
    name: ðŸ—ï¸ Build Application
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            web/package-lock.json

      # ==========================================
      # BUILD BACKEND
      # ==========================================
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./server
        run: npm ci

      - name: ðŸ—ï¸ Build Backend
        working-directory: ./server
        run: npm run build

      - name: ðŸ” Generate Prisma Client
        working-directory: ./server
        run: npx prisma generate

      - name: ðŸ“¤ Upload Backend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            server/dist/
            server/package*.json
            server/prisma/
            server/ecosystem.config.js
            server/node_modules/.prisma/
          retention-days: 1

      # ==========================================
      # BUILD FRONTEND
      # ==========================================
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./web
        run: npm ci

      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./web
        env:
          VITE_API_URL: https://patrimonioueg.duckdns.org/api/ana
        run: npm run build

      - name: ðŸ“¤ Upload Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web/dist/
          retention-days: 1

  # ==========================================
  # DEPLOY
  # ==========================================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: ðŸš€ Deploy to UEG Server
    
    steps:
      - name: ðŸ“¥ Download Backend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-deploy/

      - name: ðŸ“¥ Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-deploy/

      # ==========================================
      # PREPARE SERVER
      # ==========================================
      - name: ðŸ› ï¸ Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "ðŸ› ï¸ Preparando diretÃ³rios Docker..."
            
            # Criar backup
            mkdir -p /tmp/ana-deploy-backup
            
            # Backup dos arquivos atuais
            if [ -d "~/docker-ueg-projects/server/dist" ]; then
              echo "ðŸ’¾ Fazendo backup do backend..."
              cp -r ~/docker-ueg-projects/server/dist /tmp/ana-deploy-backup/backend-$(date +%Y%m%d-%H%M%S)
            fi
            
            if [ -d "~/docker-ueg-projects/web/dist" ]; then
              echo "ðŸ’¾ Fazendo backup do frontend..."
              cp -r ~/docker-ueg-projects/web/dist /tmp/ana-deploy-backup/frontend-$(date +%Y%m%d-%H%M%S)
            fi
            
            echo "âœ… DiretÃ³rios preparados!"

      # ==========================================
      # DEPLOY BACKEND
      # ==========================================
      - name: ðŸ“¤ Transfer Backend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "backend-deploy/dist/*"
          target: ~/docker-ueg-projects/server/
          strip_components: 2
          overwrite: true

      - name: âš™ï¸ Configure Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            cd ~/docker-ueg-projects
            
            echo "âš™ï¸ Configurando backend..."
            
            # Verificar se o .env existe (nÃ£o sobrescrever credenciais)
            if [ ! -f .env ]; then
              echo "âš ï¸ Arquivo .env nÃ£o encontrado! Criando template..."
              cat > .env << EOF
            # ConfiguraÃ§Ãµes do Banco de Dados
            ANA_DB_USER=ana_user
            ANA_DB_PASSWORD=change_me
            
            # Credenciais API ANA
            ANA_BASE_URL=https://www.ana.gov.br/hidrowebservice
            ANA_IDENTIFICADOR=change_me
            ANA_SENHA=change_me
            EOF
            fi
            
            echo "âœ… Backend configurado!"

      # ==========================================
      # DEPLOY FRONTEND
      # ==========================================
      - name: ðŸ“¤ Transfer Frontend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "frontend-deploy/*"
          target: ~/docker-ueg-projects/web/dist/
          strip_components: 1
          overwrite: true

      - name: âš™ï¸ Configure Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "âš™ï¸ Ajustando permissÃµes do frontend..."
            chmod -R 755 ~/docker-ueg-projects/web/dist
            echo "âœ… Frontend configurado!"

      # ==========================================
      # START SERVICES
      # ==========================================
      - name: ðŸš€ Start Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            cd ~/docker-ueg-projects
            
            echo "ðŸš€ Reiniciando containers Docker..."
            
            # Restart apenas os containers da ANA
            docker-compose restart ana-backend
            docker-compose restart ana-frontend
            
            # Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 5
            
            # Verificar status dos containers
            echo "ðŸ“Š Status dos containers:"
            docker-compose ps | grep ana
            
            # Verificar logs do backend
            echo "ðŸ“‹ Ãšltimas linhas do log do backend:"
            docker-compose logs --tail=20 ana-backend
            
            # Verificar se backend estÃ¡ respondendo
            echo "ðŸ¥ Testando backend..."
            docker-compose exec -T ana-backend wget -q -O- http://localhost:3001/health || echo "âš ï¸ Backend nÃ£o estÃ¡ respondendo ainda"
            
            # Recarregar Nginx gateway (sem downtime)
            echo "â™»ï¸ Recarregando Nginx..."
            docker-compose exec -T nginx nginx -s reload
            
            echo "âœ… ServiÃ§os reiniciados!"

      # ==========================================
      # POST-DEPLOY VERIFICATION
      # ==========================================
      - name: âœ… Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ðŸ” Verificando deployment..."
            echo ""
            echo "ðŸ“Š Status dos Containers:"
            cd ~/docker-ueg-projects && docker-compose ps | grep ana
            echo ""
            echo "ðŸ—‚ï¸ Arquivos Frontend:"
            ls -lh ~/docker-ueg-projects/web/dist/ | head -10
            echo ""
            echo "ðŸ—‚ï¸ Arquivos Backend:"
            ls -lh ~/docker-ueg-projects/server/dist/ | head -10
            echo ""
            echo "ðŸ“‹ Ãšltimas linhas do log do backend:"
            cd ~/docker-ueg-projects && docker-compose logs --tail=20 ana-backend
            echo ""
            echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

  # ==========================================
  # HEALTH CHECK
  # ==========================================
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    name: ðŸ¥ Health Check
    
    steps:
      - name: â³ Wait for application to start
        run: sleep 10

      - name: ðŸ¥ Check Backend Health
        run: |
          echo "ðŸ” Verificando saÃºde do backend..."
          response=$(curl -f -s https://patrimonioueg.duckdns.org/api/ana/health)
          echo "Resposta: $response"
          
          if echo "$response" | grep -q "ok"; then
            echo "âœ… Backend estÃ¡ saudÃ¡vel!"
          else
            echo "âŒ Backend nÃ£o estÃ¡ respondendo corretamente!"
            exit 1
          fi

      - name: ðŸŒ Check Frontend Availability
        run: |
          echo "ðŸ” Verificando disponibilidade do frontend..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}" https://patrimonioueg.duckdns.org/ana)
          
          if [ "$status_code" -eq 200 ]; then
            echo "âœ… Frontend estÃ¡ acessÃ­vel! (HTTP $status_code)"
          else
            echo "âŒ Frontend retornou status: $status_code"
            exit 1
          fi

      - name: ðŸŽ‰ Deployment Success
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸŒ URLs da aplicaÃ§Ã£o:"
          echo "   Frontend: https://patrimonioueg.duckdns.org/ana/"
          echo "   API:      https://patrimonioueg.duckdns.org/api/ana/"
          echo "   Health:   https://patrimonioueg.duckdns.org/api/ana/health"
          echo ""
          echo "ðŸ“Š Para monitorar:"
          echo "   ssh -p 8740 usuario@200.137.241.42"
          echo "   cd ~/docker-ueg-projects"
          echo "   docker-compose logs -f ana-backend"
          echo "   docker-compose ps"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
