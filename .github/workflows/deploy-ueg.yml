name: Deploy to UEG Server

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  # ==========================================
  # VERIFICAÃ‡ÃƒO PRÃ‰VIA
  # ==========================================
  pre-check:
    runs-on: ubuntu-latest
    name: ğŸ” Pre-deployment Checks
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Verify server connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ğŸ” Verificando servidor..."
            echo "Sistema: $(uname -a)"
            echo "EspaÃ§o em disco:"
            df -h | grep -E "Filesystem|/$"
            echo "ğŸ³ Docker:"
            docker --version
            docker-compose --version
            echo "ğŸ“Š Containers em execuÃ§Ã£o:"
            cd ~/docker-ueg-projects && docker-compose ps | grep ana || echo "Nenhum container ANA rodando"
            echo "âœ… Servidor acessÃ­vel!"

  # ==========================================
  # BUILD
  # ==========================================
  build:
    runs-on: ubuntu-latest
    needs: pre-check
    name: ğŸ—ï¸ Build Application
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            web/package-lock.json

      # ==========================================
      # BUILD BACKEND
      # ==========================================
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./server
        run: npm ci

      - name: ğŸ—ï¸ Build Backend
        working-directory: ./server
        run: npm run build

      - name: ğŸ” Generate Prisma Client
        working-directory: ./server
        run: npx prisma generate

      - name: ğŸ“¤ Upload Backend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            server/dist/
            server/package*.json
            server/prisma/
            server/ecosystem.config.js
            server/node_modules/.prisma/
          retention-days: 1

      # ==========================================
      # BUILD FRONTEND
      # ==========================================
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./web
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./web
        env:
          VITE_API_URL: https://patrimonioueg.duckdns.org/api/ana
        run: npm run build

      - name: ğŸ“¤ Upload Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web/dist/
          retention-days: 1

  # ==========================================
  # DEPLOY
  # ==========================================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: ğŸš€ Deploy to UEG Server
    
    steps:
      - name: ğŸ“¥ Download Backend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-deploy/

      - name: ğŸ“¥ Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-deploy/

      # ==========================================
      # PREPARE SERVER
      # ==========================================
      - name: ğŸ› ï¸ Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "ğŸ› ï¸ Preparando diretÃ³rios..."
            
            # Criar estrutura de diretÃ³rios
            mkdir -p /home/usuario/ana-backend
            mkdir -p /home/usuario/logs
            mkdir -p /tmp/ana-deploy-backup
            
            # Backup do backend atual (se existir)
            if [ -d "/home/usuario/ana-backend/dist" ]; then
              echo "ğŸ’¾ Fazendo backup do backend atual..."
              cp -r /home/usuario/ana-backend/dist /tmp/ana-deploy-backup/dist-$(date +%Y%m%d-%H%M%S)
            fi
            
            # Parar processo PM2 (se existir)
            echo "â¸ï¸ Parando serviÃ§os..."
            pm2 stop ana-backend 2>/dev/null || echo "Processo ana-backend nÃ£o estava rodando"
            
            # Criar diretÃ³rio frontend (sem sudo - jÃ¡ pertence ao usuario)
            mkdir -p /var/www/ana-frontend/dist
            
            # Backup do frontend atual (se existir)
            if [ -d "/var/www/ana-frontend/dist" ] && [ "$(ls -A /var/www/ana-frontend/dist 2>/dev/null)" ]; then
              echo "ğŸ’¾ Fazendo backup do frontend atual..."
              cp -r /var/www/ana-frontend/dist /tmp/ana-deploy-backup/frontend-$(date +%Y%m%d-%H%M%S)
            fi
            
            echo "âœ… DiretÃ³rios preparados!"

      # ==========================================
      # DEPLOY BACKEND
      # ==========================================
      - name: ğŸ“¤ Transfer Backend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "backend-deploy/*"
          target: /home/usuario/ana-backend/
          strip_components: 1
          overwrite: true

      - name: âš™ï¸ Configure Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            cd /home/usuario/ana-backend
            
            echo "âš™ï¸ Configurando backend..."
            
            # Criar .env de produÃ§Ã£o
            cat > .env << EOF
            PORT=3001
            NODE_ENV=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ANA_BASE_URL=${{ secrets.ANA_BASE_URL }}
            EOF
            
            # Instalar dependÃªncias de produÃ§Ã£o
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm ci --production
            
            # Aplicar migrations do Prisma
            echo "ğŸ—„ï¸ Aplicando migrations do banco..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "âœ… Backend configurado!"

      # ==========================================
      # DEPLOY FRONTEND
      # ==========================================
      - name: ğŸ“¤ Transfer Frontend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "frontend-deploy/*"
          target: /var/www/ana-frontend/dist/
          strip_components: 1
          overwrite: true

      - name: âš™ï¸ Configure Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "âš™ï¸ Ajustando permissÃµes do frontend..."
            chmod -R 755 /var/www/ana-frontend
            echo "âœ… Frontend configurado!"

      # ==========================================
      # START SERVICES
      # ==========================================
      - name: ğŸš€ Start Services (Docker)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "ğŸ³ Copiando arquivos para estrutura Docker..."
            
            # Copiar backend para estrutura Docker
            cp -r /home/usuario/ana-backend/dist/* ~/docker-ueg-projects/server/dist/ 2>/dev/null || true
            cp /home/usuario/ana-backend/package*.json ~/docker-ueg-projects/server/
            cp -r /home/usuario/ana-backend/prisma ~/docker-ueg-projects/server/
            
            # Copiar frontend para estrutura Docker
            cp -r /var/www/ana-frontend/dist/* ~/docker-ueg-projects/web/dist/
            
            # Navegar para diretÃ³rio Docker
            cd ~/docker-ueg-projects
            
            echo "ï¿½ Reconstruindo e reiniciando containers..."
            
            # Rebuild backend (se houver mudanÃ§as)
            docker-compose build ana-backend
            
            # Reiniciar containers
            docker-compose up -d --force-recreate ana-backend ana-frontend
            
            # Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando inicializaÃ§Ã£o dos containers..."
            sleep 10
            
            # Verificar status
            echo "ğŸ“Š Status dos containers:"
            docker-compose ps | grep ana
            
            # Verificar logs do backend
            echo "ğŸ“‹ Ãšltimas linhas do log do backend:"
            docker-compose logs --tail=20 ana-backend
            
            # Verificar se backend estÃ¡ respondendo
            echo "ğŸ¥ Testando backend..."
            docker exec ana-backend wget -qO- http://localhost:3001/health || echo "âš ï¸ Backend nÃ£o estÃ¡ respondendo ainda"
            
            # Verificar arquivos do frontend
            echo "ï¿½ Verificando arquivos do frontend:"
            docker exec ana-frontend ls -lh /usr/share/nginx/html/
            
            # Reiniciar nginx gateway
            echo "â™»ï¸ Reiniciando Nginx gateway..."
            docker-compose restart nginx
            
            echo "âœ… Containers Docker reiniciados com sucesso!"

      # ==========================================
      # POST-DEPLOY VERIFICATION
      # ==========================================
      - name: âœ… Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ğŸ” Verificando deployment..."
            cd ~/docker-ueg-projects
            echo ""
            echo "ğŸ“Š Status dos containers:"
            docker-compose ps | grep ana
            echo ""
            echo "ğŸ—‚ï¸ Arquivos Frontend (dentro do container):"
            docker exec ana-frontend ls -lh /usr/share/nginx/html/ | head -10
            echo ""
            echo "ğŸ—‚ï¸ Arquivos Backend (dentro do container):"
            docker exec ana-backend ls -lh /app/dist/ | head -10
            echo ""
            echo "ğŸ“‹ Ãšltimas linhas do log do backend:"
            docker-compose logs --tail=20 ana-backend
            echo ""
            echo "ğŸ“‹ Ãšltimas linhas do log do frontend:"
            docker-compose logs --tail=10 ana-frontend
            echo ""
            echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

  # ==========================================
  # HEALTH CHECK
  # ==========================================
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    name: ğŸ¥ Health Check
    
    steps:
      - name: â³ Wait for application to start
        run: sleep 10

      - name: ğŸ¥ Check Backend Health
        run: |
          echo "ğŸ” Verificando saÃºde do backend..."
          response=$(curl -f -s https://patrimonioueg.duckdns.org/api/ana/health)
          echo "Resposta: $response"
          
          if echo "$response" | grep -q "ok"; then
            echo "âœ… Backend estÃ¡ saudÃ¡vel!"
          else
            echo "âŒ Backend nÃ£o estÃ¡ respondendo corretamente!"
            exit 1
          fi

      - name: ğŸŒ Check Frontend Availability
        run: |
          echo "ğŸ” Verificando disponibilidade do frontend..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}" https://patrimonioueg.duckdns.org/ana)
          
          if [ "$status_code" -eq 200 ]; then
            echo "âœ… Frontend estÃ¡ acessÃ­vel! (HTTP $status_code)"
          else
            echo "âŒ Frontend retornou status: $status_code"
            exit 1
          fi

      - name: ğŸ‰ Deployment Success
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY DOCKER CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ URLs da aplicaÃ§Ã£o:"
          echo "   Frontend: https://patrimonioueg.duckdns.org/ana/"
          echo "   Backend:  https://patrimonioueg.duckdns.org/api/ana/"
          echo "   Health:   https://patrimonioueg.duckdns.org/api/ana/health"
          echo ""
          echo "ğŸ“Š Para monitorar (Docker):"
          echo "   ssh -p 8740 usuario@200.137.241.42"
          echo "   cd ~/docker-ueg-projects"
          echo "   docker-compose logs -f ana-backend"
          echo "   docker-compose ps"
          echo "   docker stats"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
