name: Deploy to UEG Server

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  # ==========================================
  # VERIFICAÃ‡ÃƒO PRÃ‰VIA
  # ==========================================
  pre-check:
    runs-on: ubuntu-latest
    name: ğŸ” Pre-deployment Checks
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Verify server connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ğŸ” Verificando servidor..."
            echo "Sistema: $(uname -a)"
            echo "EspaÃ§o em disco:"
            df -h | grep -E "Filesystem|/$"
            echo "Processos PM2:"
            pm2 list || echo "PM2 nÃ£o disponÃ­vel"
            echo "âœ… Servidor acessÃ­vel!"

  # ==========================================
  # BUILD
  # ==========================================
  build:
    runs-on: ubuntu-latest
    needs: pre-check
    name: ğŸ—ï¸ Build Application
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            server/package-lock.json
            web/package-lock.json

      # ==========================================
      # BUILD BACKEND
      # ==========================================
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./server
        run: npm ci

      - name: ğŸ—ï¸ Build Backend
        working-directory: ./server
        run: npm run build

      - name: ğŸ” Generate Prisma Client
        working-directory: ./server
        run: npx prisma generate

      - name: ğŸ“¤ Upload Backend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            server/dist/
            server/package*.json
            server/prisma/
            server/node_modules/.prisma/
          retention-days: 1

      # ==========================================
      # BUILD FRONTEND
      # ==========================================
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./web
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./web
        env:
          VITE_API_URL: https://patrimonioueg.duckdns.org/api/ana
        run: npm run build

      - name: ğŸ“¤ Upload Frontend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web/dist/
          retention-days: 1

  # ==========================================
  # DEPLOY
  # ==========================================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: ğŸš€ Deploy to UEG Server
    
    steps:
      - name: ğŸ“¥ Download Backend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-deploy/

      - name: ğŸ“¥ Download Frontend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-deploy/

      # ==========================================
      # PREPARE SERVER
      # ==========================================
      - name: ğŸ› ï¸ Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "ğŸ› ï¸ Preparando diretÃ³rios..."
            
            # Criar estrutura de diretÃ³rios
            mkdir -p /home/usuario/ana-backend
            mkdir -p /home/usuario/logs
            mkdir -p /tmp/ana-deploy-backup
            
            # Backup do backend atual (se existir)
            if [ -d "/home/usuario/ana-backend/dist" ]; then
              echo "ğŸ’¾ Fazendo backup do backend atual..."
              cp -r /home/usuario/ana-backend/dist /tmp/ana-deploy-backup/dist-$(date +%Y%m%d-%H%M%S)
            fi
            
            # Parar processo PM2 (se existir)
            echo "â¸ï¸ Parando serviÃ§os..."
            pm2 stop ana-backend 2>/dev/null || echo "Processo ana-backend nÃ£o estava rodando"
            
            # Criar diretÃ³rio frontend
            sudo mkdir -p /var/www/ana-frontend
            sudo chown -R usuario:usuario /var/www/ana-frontend
            
            # Backup do frontend atual (se existir)
            if [ -d "/var/www/ana-frontend/dist" ]; then
              echo "ğŸ’¾ Fazendo backup do frontend atual..."
              sudo cp -r /var/www/ana-frontend/dist /tmp/ana-deploy-backup/frontend-$(date +%Y%m%d-%H%M%S)
            fi
            
            echo "âœ… DiretÃ³rios preparados!"

      # ==========================================
      # DEPLOY BACKEND
      # ==========================================
      - name: ğŸ“¤ Transfer Backend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "backend-deploy/*"
          target: /home/usuario/ana-backend/
          strip_components: 1
          overwrite: true

      - name: âš™ï¸ Configure Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            cd /home/usuario/ana-backend
            
            echo "âš™ï¸ Configurando backend..."
            
            # Criar .env de produÃ§Ã£o
            cat > .env << EOF
            PORT=3001
            NODE_ENV=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ANA_BASE_URL=${{ secrets.ANA_BASE_URL }}
            EOF
            
            # Instalar dependÃªncias de produÃ§Ã£o
            echo "ğŸ“¦ Instalando dependÃªncias..."
            npm ci --production
            
            # Criar ecosystem config para PM2
            cat > ecosystem.config.js << 'EOFPM2'
            module.exports = {
              apps: [{
                name: 'ana-backend',
                script: './dist/index.js',
                cwd: '/home/usuario/ana-backend',
                instances: 1,
                exec_mode: 'cluster',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3001
                },
                error_file: '/home/usuario/logs/ana-backend-error.log',
                out_file: '/home/usuario/logs/ana-backend-out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
                merge_logs: true,
                autorestart: true,
                max_restarts: 10,
                min_uptime: '10s',
                restart_delay: 4000
              }]
            };
            EOFPM2
            
            # Aplicar migrations do Prisma
            echo "ğŸ—„ï¸ Aplicando migrations do banco..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "âœ… Backend configurado!"

      # ==========================================
      # DEPLOY FRONTEND
      # ==========================================
      - name: ğŸ“¤ Transfer Frontend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          source: "frontend-deploy/*"
          target: /var/www/ana-frontend/dist/
          strip_components: 1
          overwrite: true

      - name: âš™ï¸ Configure Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "âš™ï¸ Ajustando permissÃµes do frontend..."
            sudo chown -R www-data:www-data /var/www/ana-frontend
            sudo chmod -R 755 /var/www/ana-frontend
            echo "âœ… Frontend configurado!"

      # ==========================================
      # START SERVICES
      # ==========================================
      - name: ğŸš€ Start Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            cd /home/usuario/ana-backend
            
            # Deletar processo antigo do PM2 (se existir)
            pm2 delete ana-backend 2>/dev/null || true
            
            # Iniciar backend com PM2
            echo "ğŸš€ Iniciando backend..."
            pm2 start ecosystem.config.js
            pm2 save --force
            
            # Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando inicializaÃ§Ã£o do backend..."
            sleep 5
            
            # Verificar status
            echo "ğŸ“Š Status dos processos:"
            pm2 list
            
            # Verificar logs
            echo "ğŸ“‹ Ãšltimas linhas do log:"
            pm2 logs ana-backend --lines 10 --nostream
            
            # Verificar se backend estÃ¡ respondendo
            echo "ğŸ¥ Testando backend..."
            curl -f http://localhost:3001/health || echo "âš ï¸ Backend nÃ£o estÃ¡ respondendo ainda"
            
            # Testar configuraÃ§Ã£o do Nginx
            echo "ğŸ”§ Testando Nginx..."
            sudo nginx -t
            
            # Recarregar Nginx (sem downtime)
            echo "â™»ï¸ Recarregando Nginx..."
            sudo systemctl reload nginx
            
            echo "âœ… ServiÃ§os iniciados!"

      # ==========================================
      # POST-DEPLOY VERIFICATION
      # ==========================================
      - name: âœ… Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.UEG_SSH_HOST }}
          port: ${{ secrets.UEG_SSH_PORT }}
          username: ${{ secrets.UEG_SSH_USER }}
          key: ${{ secrets.UEG_SSH_KEY }}
          script: |
            echo "ğŸ” Verificando deployment..."
            echo ""
            echo "ğŸ“Š Status PM2:"
            pm2 list
            echo ""
            echo "ğŸ—‚ï¸ Arquivos Frontend:"
            ls -lh /var/www/ana-frontend/dist/ | head -10
            echo ""
            echo "ğŸ—‚ï¸ Arquivos Backend:"
            ls -lh /home/usuario/ana-backend/dist/ | head -10
            echo ""
            echo "ğŸ“‹ Ãšltimas linhas do log do backend:"
            pm2 logs ana-backend --lines 20 --nostream
            echo ""
            echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

  # ==========================================
  # HEALTH CHECK
  # ==========================================
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    name: ğŸ¥ Health Check
    
    steps:
      - name: â³ Wait for application to start
        run: sleep 10

      - name: ğŸ¥ Check Backend Health
        run: |
          echo "ğŸ” Verificando saÃºde do backend..."
          response=$(curl -f -s https://patrimonioueg.duckdns.org/api/ana/health)
          echo "Resposta: $response"
          
          if echo "$response" | grep -q "ok"; then
            echo "âœ… Backend estÃ¡ saudÃ¡vel!"
          else
            echo "âŒ Backend nÃ£o estÃ¡ respondendo corretamente!"
            exit 1
          fi

      - name: ğŸŒ Check Frontend Availability
        run: |
          echo "ğŸ” Verificando disponibilidade do frontend..."
          status_code=$(curl -o /dev/null -s -w "%{http_code}" https://patrimonioueg.duckdns.org/ana)
          
          if [ "$status_code" -eq 200 ]; then
            echo "âœ… Frontend estÃ¡ acessÃ­vel! (HTTP $status_code)"
          else
            echo "âŒ Frontend retornou status: $status_code"
            exit 1
          fi

      - name: ğŸ‰ Deployment Success
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ URLs da aplicaÃ§Ã£o:"
          echo "   Frontend: https://patrimonioueg.duckdns.org/ana"
          echo "   Backend:  https://patrimonioueg.duckdns.org/api/ana"
          echo "   Health:   https://patrimonioueg.duckdns.org/api/ana/health"
          echo ""
          echo "ğŸ“Š Para monitorar:"
          echo "   ssh -p 8740 usuario@200.137.241.42"
          echo "   pm2 logs ana-backend"
          echo "   pm2 monit"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
