# ============================================
# PROJETO: ANA HIDRO
# Isolado na rede ana_network
# ============================================

# Backend API
location /api/ana {
    proxy_pass http://ana-backend:3001/api/ana;
    include /etc/nginx/includes/proxy-params.conf;
    
    # Headers CORS para API
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization" always;
    add_header Access-Control-Max-Age 86400 always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    # Timeouts espec√≠ficos para API externa
    proxy_read_timeout 90s;
    proxy_connect_timeout 10s;
    proxy_send_timeout 90s;
    
    # Headers adicionais
    proxy_set_header X-API-Path "/api/ana";
}

# Frontend SPA
location /ana/ {
    proxy_pass http://ana-frontend:80/;
    include /etc/nginx/includes/proxy-params.conf;
    
    # Headers CORS para permitir carregamento de assets
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
    
    # SPA fallback para rotas do React Router
    proxy_intercept_errors on;
    error_page 404 = /ana/index.html;
}

# Redirecionar /ana para /ana/
location = /ana {
    return 301 /ana/;
}
